{% extends 'base.html' %}
{% block title %}All Orders{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Inspiring Journey - My Store Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    /* Base Styles */
    body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        background: radial-gradient(circle, #e3f2fd, #bbdefb);
        min-height: 100vh; /* Changed from height: 100vh */
        }

    .layout {
        display: flex;
        height: 100vh;  /* full screen height */
        width: 100%;    /* add this */
        }

  

    /* Header Enhancements */
    .header {
      background:  #ffffff;
      padding: 30px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-bottom: 40px;
      color:  #003366;
      /* New: Make top corners rounded to match the bottom corners */
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 2 rem; /* Larger title */
      font-weight: 700;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1 rem; /* Clearer welcome message */
      margin-top: 5px;
      opacity: 0.9;
    }

    .container-fluid {
      max-width: 1300px; /* Slightly wider container */
      margin: 0 auto;
      padding: 0 20px; /* More padding */
    }

    /* KPI Section - Retain pop, ensure cohesion */
    .kpi-section {
        display: grid;
        /* This rule will create columns that are at least 250px wide, growing to take up available space */
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        margin-bottom: 50px;
        padding: 0 20px; /* Add some padding to prevent cards from touching the edges */
    }

    .stat-card {
      background: white;
      padding: 35px 30px; /* More padding */
      border-radius: 15px; /* Softer rounded corners */
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Stronger shadow */
      text-align: center;
      border-left: 6px solid transparent; /* Thicker border for pop */
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-8px); /* More pronounced lift */
      box-shadow: 0 8px 20px rgba(0,0,0,0.15); /* Even stronger shadow on hover */
    }

    .stat-card::before { /* Decorative element */
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 10px;
      background: var(--card-accent-color, transparent); /* Use CSS variable */
      transition: height 0.3s ease-in-out;
    }

    .stat-card:hover::before {
        height: 100%; /* Fill on hover - optional but cool effect */
        opacity: 0.05; /* Subtle overlay */
    }


    /* KPI Colors - Retained original pop, set as custom properties */
    .stat-card.selling-well { --card-accent-color: #10b981; border-left-color: #10b981; } /* Green */
    .stat-card.inventory { --card-accent-color: #3b82f6; border-left-color: #3b82f6; } /* Blue */
    .stat-card.attention { --card-accent-color: #FFA500; border-left-color: #FFA500; } /* Orange */


    .stat-number {
      font-size: 1.5 rem; /* Larger numbers */
      font-weight: 800; /* Bolder */
      margin-bottom: 10px;
      line-height: 1;
    }

    .stat-number.well-sold { color: #10b981; }
    .stat-number.blue { color: #3b82f6; }
    .stat-number.info { color: #FFA500; }

    .stat-label {
      color: #4a5568; /* Slightly darker label */
      font-size: .7 rem; /* Slightly larger label */
      font-weight: 600; /* Bolder label */
      margin-bottom: 10px;
    }

    .stat-change {
      font-size: 0.6 rem; /* Slightly larger change text */
      margin-top: 12px;
      padding: 6px 12px;
      border-radius: 25px; /* More rounded pill shape */
      font-weight: 600;
    }

    .stat-change.up {
      background: #dcfce7;
      color: #16a34a; /* Darker green */
    }

    .stat-change.down {
      background: #fee2e2;
      color: #ef4444; /* Darker red */
    }

    .stat-card .btn {
        margin-top: 20px;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    .stat-card .btn-outline-primary {
        color: #3b82f6;
        border-color: #3b82f6;
    }
    .stat-card .btn-outline-primary:hover {
        background-color: #3b82f6;
        color: white;
    }
    .stat-card .btn-outline-info { /* Assuming orange is now info */
        color: #FFA500;
        border-color: #FFA500;
    }
    .stat-card .btn-outline-info:hover {
        background-color: #FFA500;
        color: white;
    }


    /* Main Content Sections */
    .main-content {
      display: grid;
      grid-template-columns: 1fr; /* Single column for better flow on larger screens too */
      gap: 30px;
      margin-bottom: 50px;
    }

    .section {
      background: white;
      border-radius: 15px; /* Consistent rounded corners */
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .section-header {
      padding: 25px 30px 20px;
      border-bottom: 1px solid #e2e8f0;
      background-color: #f0f8ff; /* Light blue background for section headers */
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
    }

    .section-title {
      font-size: 1.3rem; /* Larger section titles */
      font-weight: 700;
      color: #2b6cb0; /* Stronger blue */
      margin-bottom: 5px;
    }

    .section-subtitle {
      color: #718096;
      font-size: .7rem;
    }

    .section-content {
      padding: 0;
      position: relative; /* For loading spinner */
    }

    /* Chart Styling */
    .chart-container {
      position: relative;
      height: 450px; /* Taller chart */
      width: 100%;
      padding: 25px;
      background-color: #ffffff; /* Ensure white background for chart area */
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    /* Historical Trends Table Styling */
    .table-responsive {
        margin-top: 20px;
        position: relative;
        padding: 0 25px 25px; /* Padding for the table content */
    }
    .historical-trends-table {
        width: 100%;
        border-collapse: separate; /* Use separate for rounded borders */
        border-spacing: 0; /* Remove space between cells */
        margin-top: 15px;
        border-radius: 10px; /* Rounded table corners */
        overflow: hidden; /* Ensures internal borders are clipped */
        border: 1px solid #e2e8f0; /* Overall table border */
    }
    .historical-trends-table th, .historical-trends-table td {
        padding: 15px 20px; /* More padding */
        text-align: left;
        border-bottom: 1px solid #edf2f7; /* Lighter internal borders */
        border-right: 1px solid #edf2f7;
    }
    .historical-trends-table th:last-child, .historical-trends-table td:last-child {
        border-right: none; /* No right border on last column */
    }
    .historical-trends-table th {
        background-color: #e6f2ff; /* Light blue header background for cohesion */
        font-weight: 700;
        color: #2c5282; /* Darker blue text */
        text-transform: uppercase;
        font-size: 0.6rem;
        letter-spacing: 0.05em;
    }
    .historical-trends-table tbody tr:nth-child(even) {
        background-color: #f9fbfd; /* Very subtle alternating row color */
    }
    .historical-trends-table tbody tr:hover {
        background-color: #eef7ff; /* Lighter blue on hover */
    }
    .historical-trends-table tbody tr:last-child td {
        border-bottom: none; /* No bottom border on last row */
    }


    /* Loading States - consistent and centered */
    .loading-spinner-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px; /* More padding for a larger loading area */
      text-align: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.85); /* Slightly less opaque */
      z-index: 10;
      border-radius: 15px; /* Match section corners */
    }

    .loading-spinner-container .spinner-border {
      width: 3rem; /* Larger spinner */
      height: 3rem;
      margin-bottom: 15px;
      color: #3b82f6 !important; /* Force primary blue color */
    }

    .loading-spinner-container p {
      color: #64748b;
      font-size: 1.1rem; /* Larger loading text */
    }

    /* Modal Styling - take up almost whole page */
    /* Modal Styling - take up almost whole page */
    .modal-dialog {
        width: 98vw;
        max-width: 98vw;
        height: 80vh;
        /* Use flexbox to center the modal */
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0; /* Override any default margin */
        }

        /* Override Bootstrap's default modal size classes as they conflict with the desired full-page width */
        .modal-lg, .modal-xl {
        --bs-modal-width: 98vw !important;
        width: 98vw !important;
        max-width: 98vw !important;
        height: 87vh !important;
        max-height: 87vh !important;

        }

        .modal-content {
        height: 100%;
        max-height: 100% !important;
        width: 80% !important;
        max-width: 100% !important;
        top: 9% !important;
        left: 9% !important;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        }


    .modal-header {
        border-bottom: 1px solid #e0e6ed;
        background-color: #f0f8ff; /* Light blue header for modals */
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        padding: 20px 25px;
    }
    .modal-header .modal-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: #2b6cb0;
    }
    .modal-header .btn-close {
        font-size: 1.2rem;
    }

    .modal-body {
        flex-grow: 1; /* Allow body to take up remaining space */
        overflow-y: auto; /* Enable vertical scrolling for modal content */
        overflow-x: hidden; /* Prevent horizontal scrolling of the modal body itself */
        padding: 25px;
        position: relative; /* For potential internal loading spinners */
    }

    .modal-footer {
        border-top: 1px solid #e0e6ed;
        padding: 15px 25px;
        background-color: #f8fafc;
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
    }
    
    /* Specific modal header colors if needed */
    .modal-header.bg-warning {
        background-color: #ffebcc !important; /* Lighter orange for warning modal header */
        color: #8c5400 !important; /* Darker text for warning */
    }

    
    /* Mobile Responsive Adjustments */
    @media (max-width: 800px) {
    .modal-dialog {
        max-width: 90vw !important;
        width: 90vw !important;
        height: 87vh;
    }
    .modal-content {
        height: 100%;
        max-height: 100% !important;
        width: 80% !important;
        max-width: 100% !important;
        top: 9% !important;
        left: 0% !important;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        }
    }

    @media (min-width: 801px) {
    .modal-dialog {
        max-width: 90vw !important;
        width: 90vw !important;
        height: 87vh;
    }

      .header p {
        font-size: 1rem;
      }
      .container-fluid {
        padding: 0 15px;
      }
      
      .stat-card {
        padding: 30px 25px;
      }
      .stat-number {
        font-size: 2.5rem;
      }
      .section-title {
        font-size: 1.5rem;
      }
      .chart-container {
        height: 350px;
        padding: 20px;
      }
      .historical-trends-table th, .historical-trends-table td {
          padding: 12px 15px;
      }
      .modal-dialog {
          max-width: 98vw !important; /* Almost full width on small screens */
          width: 98vw !important;
          height: 87vh;
          margin: 1vh auto !important;
      }
      .modal-content {
        height: 100%;
        max-height: 100% !important;
        width: 80% !important;
        max-width: 100% !important;
        top: 9% !important;
        left: 9% !important;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        }
      
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="container-fluid">
      <h1>Welcome to Your Analytics Oasis, {{ company.name }}!</h1>
      <p>Dive deep into your business insights and watch your success unfold.</p>
    </div>
  </header>

  
    <section class="kpi-section">
        <div class="stat-card selling-well clickable-kpi-card"
             data-bs-toggle="modal"
             data-bs-target="#itemsSellingWellModal"
             data-url="{% url 'get_items_selling_well_modal_content' %}">
            <div class="stat-number well-sold" id="itemsSellingWellCount">0</div>
            <div class="stat-label">Items Selling Well</div>
            <div class="stat-change up">In the last 30 days</div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-3"
                    data-bs-toggle="modal"
                    data-bs-target="#itemsSellingWellModal"
                    data-url="{% url 'get_items_selling_well_modal_content' %}">
                View Details
            </button>
        </div>

        <div class="stat-card inventory clickable-kpi-card"
             data-bs-toggle="modal"
             data-bs-target="#totalInventoryValueModal"
             data-url="{% url 'total_inventory_value_modal' %}">
            <div class="stat-number blue" id="inventory-value">${{ totalInventoryValue|floatformat:2 }}</div>
            <div class="stat-label">Total Inventory Value</div>
            <div class="stat-change up">{{ totalUnitsInStock }} items in stock</div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-3"
                    data-bs-toggle="modal"
                    data-bs-target="#totalInventoryValueModal"
                    data-url="{% url 'total_inventory_value_modal' %}">
                View All Items
            </button>
        </div>

        <div class="stat-card attention clickable-kpi-card"
             data-bs-toggle="modal"
             data-bs-target="#itemsToSellModal"
             data-url="{% url 'items_to_sell_modal' %}">
            <div class="stat-number info" id="items-attention-count">{{ items_needing_attention_count }}</div>
            <div class="stat-label">Items Need Attention</div>
            <div class="stat-change down">Running low or not selling</div>
            <button type="button" class="btn btn-sm btn-outline-info mt-3"
                    data-bs-toggle="modal"
                    data-bs-target="#itemsToSellModal"
                    data-url="{% url 'items_to_sell_modal' %}"
                    id="openItemsToSellModalBtn">
                View Details
            </button>
        </div>
    </section>

    <div class="main-content single-column">
      <section class="section">
        <div class="section-header d-flex justify-content-between align-items-center">
            <h2 id="dynamicDashboardGraphTitle" class="section-title mb-0"></h2>
            <button type="button" class="btn btn-sm btn-outline-primary" id="customizeGraphButton">
                <i class="bi bi-gear me-1"></i> Customize
            </button>
        </div>
        <div class="section-content">
            <div class="chart-container">
                <canvas id="mainDashboardGraph"></canvas>
                <div id="mainGraphLoadingSpinner" class="loading-spinner-container" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading graph data...</p>
                </div>
            </div>
        </div>
      </section>

    </div>

    <section class="section mt-4">
      <div class="section-header d-flex justify-content-between align-items-center">
        <h2 class="section-title mb-0">Historical Data Trends</h2>

        <div>
            <button type="button" class="btn btn-sm btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#historicalTrendsModal" id="openHistoricalTrendsModalBtn">
                Customize Table Columns
            </button>
        </div>
      </div>
      <div class="section-content">
        <div class="table-responsive" id="historicalSummaryTableContainer" style="display: none;">
          <table class="table table-striped table-hover historical-trends-table">
            <thead>
              <tr id="dashboardTableHeaders"></tr>
            </thead>
            <tbody id="dashboardTableBody">
              </tbody>
          </table>
          <div id="historicalSummaryLoading" class="loading-spinner-container">
              <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-muted">Loading historical data...</p>
          </div>
        </div>
      </div>
    </section>

 

<div class="modal fade" id="itemsToSellModal" tabindex="-1" aria-labelledby="itemsToSellModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable"> {# Added modal-dialog-scrollable #}
      <div class="modal-content">
        <div class="modal-header bg-warning"> {# Changed to bg-warning and text-dark #}
          <h5 class="modal-title" id="itemsToSellModalLabel">
              <i class="bi bi-exclamation-triangle"></i> Items Needing Attention {# Changed icon #}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="itemsToSellModalContent">
          {# Content will be loaded here via AJAX, keep this empty initially #}
          <div class="loading-spinner-container text-center py-5">
              <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading items needing attention...</p>
          </div>
        </div>
        {# Removed the entire modal-footer div as requested #}
      </div>
    </div>
</div>

  <div class="modal fade" id="profitTrendsModal" tabindex="-1" aria-labelledby="profitTrendsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profitTrendsModalLabel">Profit Trends</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="profitTrendsModalContent">
                <div class="loading-spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading profit trends...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="totalInventoryValueModal" tabindex="-1" aria-labelledby="totalInventoryValueModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="totalInventoryValueModalLabel">Inventory Value Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="totalInventoryValueModalContent">
                <div class="loading-spinner-container text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading inventory value insights...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="graphCustomizationModal" tabindex="-1" aria-labelledby="graphCustomizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="graphCustomizationModalLabel">Graph Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="graphCustomizationModalContent">
                <div class="loading-spinner-container text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading customization options...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="itemsSellingWellModal" tabindex="-1" aria-labelledby="itemsSellingWellModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success-subtle"> {# Changed to bg-warning and text-dark #}
                <h5 class="modal-title" id="itemsSellingWellModal">
                    <i class="bi bi-graph-up"></i> Top Selling Items {# Changed icon #}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="itemsSellingWellModalContent">
                <div class="loading-spinner-container text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading top selling items...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historicalTrendsModal" tabindex="-1" aria-labelledby="historicalTrendsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historicalTrendsModalLabel">Customize Historical Data Trends</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="historicalTrendsModalBody">
                <div class="loading-spinner-container text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading customization options...</p>
                </div>
            </div>
            </div>
    </div>
</div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  
  <script>
    // Make companyId a globally accessible variable

    let companyId;

    document.addEventListener('DOMContentLoaded', function() {
        companyId = "{{ company.id }}";
        
        // This array will hold the currently displayed metrics for the dashboard table
        let currentDashboardMetrics = ['revenue', 'net_profit', 'quantity_sold', 'cogs']; // Default metrics

        // --- JavaScript for KPI Data Fetch ---
        async function fetchKpiData() {
            try {
                const response = await fetch('/inventory/api/dashboard-kpi-data/');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const totalSalesElement = document.getElementById('totalSales');
                if (totalSalesElement) totalSalesElement.textContent = parseFloat(data.total_sales).toFixed(2);
                
                const totalProfitElement = document.getElementById('totalProfit');
                if (totalProfitElement) totalProfitElement.textContent = parseFloat(data.total_profit).toFixed(2);
                
                const totalOrdersElement = document.getElementById('totalOrders');
                if (totalOrdersElement) totalOrdersElement.textContent = parseInt(data.total_orders).toLocaleString();
                
                const grossProfitMarginElement = document.getElementById('grossProfitMargin');
                if (grossProfitMarginElement) grossProfitMarginElement.textContent = parseFloat(data.gross_profit_margin).toFixed(2);

                // UPDATED: Populate Total Inventory Value
                const totalInventoryValueElement = document.getElementById('inventory-value');
                if (totalInventoryValueElement) {
                    // Use || 0 to default to 0 if data.total_inventory_value is null/undefined
                    totalInventoryValueElement.textContent = '$' + parseFloat(data.total_inventory_value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }

                // UPDATED: Populate Items Need Attention Count
                const itemsAttentionCountElement = document.getElementById('items-attention-count');
                if (itemsAttentionCountElement) {
                    // Use || 0 to default to 0 if data.items_needing_attention_count is null/undefined
                    itemsAttentionCountElement.textContent = parseInt(data.items_needing_attention_count || 0).toLocaleString();
                }
                
                document.getElementById('itemsSellingWellCount').textContent = parseInt(data.num_items_selling_well || 0).toLocaleString();


            } catch (error) {
                console.error('Error fetching KPI data:', error);
                // Set to 0 or $0.00 on error
                const totalSalesElement = document.getElementById('totalSales');
                if (totalSalesElement) totalSalesElement.textContent = '0.00';
                
                const totalProfitElement = document.getElementById('totalProfit');
                if (totalProfitElement) totalProfitElement.textContent = '0.00';
                
                const totalOrdersElement = document.getElementById('totalOrders');
                if (totalOrdersElement) totalOrdersElement.textContent = '0';
                
                const grossProfitMarginElement = document.getElementById('grossProfitMargin');
                if (grossProfitMarginElement) grossProfitMarginElement.textContent = '0.00';

                const totalInventoryValueElement = document.getElementById('inventory-value');
                if (totalInventoryValueElement) totalInventoryValueElement.textContent = '$0.00'; // Formatted for currency

                const itemsAttentionCountElement = document.getElementById('items-attention-count');
                if (itemsAttentionCountElement) itemsAttentionCountElement.textContent = '0'; // For count
                
                document.getElementById('itemsSellingWellCount').textContent = '0'; // For count
            }
        }

        fetchKpiData();

        // --- CUSTOMIZABLE GRAPH LOGIC (UNCHANGED) ---
        const mainGraphCtx = document.getElementById('mainDashboardGraph');
        let mainDashboardChartInstance;
        const mainGraphLoadingSpinner = document.getElementById('mainGraphLoadingSpinner');
        const dynamicDashboardGraphTitle = document.getElementById('dynamicDashboardGraphTitle');

        window.updateMainDashboardGraph = async function() {
            const metric = localStorage.getItem('dashboardGraphMetric') || 'sales';
            const timePeriod = localStorage.getItem('dashboardGraphTimePeriod') || 'month';

            let metricLabel = metric.charAt(0).toUpperCase() + metric.slice(1);
            if (metric === 'gross_profit_margin') metricLabel = 'Gross Profit Margin';
            if (metric === 'num_orders') metricLabel = 'Number of Orders';

            let timePeriodDisplay = timePeriod.charAt(0).toUpperCase() + timePeriod.slice(1);
            if (timePeriod === 'week') timePeriodDisplay = 'This Week';
            if (timePeriod === 'month') timePeriodDisplay = 'This Month';
            if (timePeriod === 'year') timePeriodDisplay = 'This Year';

            dynamicDashboardGraphTitle.textContent = `Overall ${metricLabel} Trend ${timePeriodDisplay}`;

            if (mainGraphLoadingSpinner) mainGraphLoadingSpinner.style.display = 'flex';
            if (mainGraphCtx) mainGraphCtx.style.display = 'none';


            try {
                const response = await fetch(`/inventory/api/dashboard-graph-data/?metric=${metric}&time_period=${timePeriod}`);
                const data = await response.json();

                const chartData = {
                    labels: data.labels,
                    datasets: [{
                        label: metricLabel,
                        data: data.data,
                        borderColor: '#3b82f6', /* Changed to a more prominent blue */
                        backgroundColor: 'rgba(59, 130, 246, 0.3)', /* Adjusted background for blue theme */
                        tension: 0.4, /* Slightly more curve */
                        fill: true,
                    }]
                };

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: false,
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    
                                    // Get the value from the context object
                                    const value = context.parsed.y;
                                    
                                    // Assuming `metricType` is available in the scope where the chart is defined
                                    // You may need to pass it in or retrieve it from your data object
                                    if (value !== null) {
                                        if (metricType === 'currency' || metricType === 'revenue') {
                                            label += '$' + value.toLocaleString();
                                        } else if (metricType === 'percentage') {
                                            label += value.toFixed(1) + '%';
                                        } else {
                                            // For 'integer' metrics like 'Number of Orders'
                                            label += value;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: false },
                            grid: {
                                color: '#e2e8f0' /* Lighter grid lines */
                            }
                        },
                       y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (metric === 'gross_profit_margin' ? 'Percentage' : 'Amount'),
                                color: '#4a5568'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (metric === 'gross_profit_margin') {
                                        return value.toLocaleString() + '%';
                                    } else if (metric === 'num_orders') {
                                        return value.toLocaleString(); // Return the number without any symbol
                                    } else {
                                        // This handles 'sales', 'profit', etc.
                                        return '$' + value.toLocaleString();
                                    }
                                },
                                color: '#4a5568' /* Tick label color */
                            },
                            grid: {
                                color: '#e2e8f0' /* Lighter grid lines */
                            }
                        }
                    }
                };

                if (mainDashboardChartInstance) {
                    mainDashboardChartInstance.data = chartData;
                    mainDashboardChartInstance.options = chartOptions;
                    mainDashboardChartInstance.update();
                } else {
                    mainDashboardChartInstance = new Chart(mainGraphCtx, {
                        type: 'line',
                        data: chartData,
                        options: chartOptions
                    });
                }
            } catch (error) {
                console.error('Error fetching main dashboard graph data:', error);
                if (mainDashboardChartInstance) {
                    mainDashboardChartInstance.destroy();
                    mainDashboardChartInstance = null;
                }
                if (mainGraphCtx) mainGraphCtx.style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger text-center py-5';
                errorDiv.textContent = 'Failed to load graph data. Please check your backend API.';
                if (mainGraphCtx && mainGraphCtx.parentNode) mainGraphCtx.parentNode.appendChild(errorDiv);
            } finally {
                if (mainGraphLoadingSpinner) mainGraphLoadingSpinner.style.display = 'none';
                if (mainGraphCtx) mainGraphCtx.style.display = 'block';
            }
        };

        updateMainDashboardGraph();

        // --- MODAL HANDLING FOR GRAPH CUSTOMIZATION (UNCHANGED) ---
        const customizeGraphButton = document.getElementById('customizeGraphButton');
        const graphCustomizationModalElement = document.getElementById('graphCustomizationModal');
        const graphCustomizationModal = new bootstrap.Modal(graphCustomizationModalElement);
        const modalContentDiv = document.getElementById('graphCustomizationModalContent');

        customizeGraphButton.addEventListener('click', function() {
            modalContentDiv.innerHTML = `
                <div class="loading-spinner-container text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading customization options...</p>
                </div>
            `;
            graphCustomizationModal.show();

            fetch('/inventory/get-graph-customization-modal-content/')
                .then(response => response.text())
                .then(html => {
                    modalContentDiv.innerHTML = html;
                    const scripts = modalContentDiv.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.textContent = oldScript.textContent;
                        if (oldScript.parentNode) {
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        } else {
                            modalContentDiv.appendChild(newScript);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading graph customization modal content:', error);
                    modalContentDiv.innerHTML = `<p class="text-danger text-center">Failed to load customization options. Please try again.</p>`;
                });
        });

        graphCustomizationModalElement.addEventListener('hidden.bs.modal', function () {
            const modalContentDiv = document.getElementById('graphCustomizationModalContent');
            modalContentDiv.innerHTML = `
                <div class="loading-spinner-container text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading customization options...</p>
                </div>
            `;
        });

        // --- Other Modal Handling (Existing code, included for completeness - UNCHANGED) ---
        const profitTrendsModal = document.getElementById('profitTrendsModal');
        if (profitTrendsModal) {
            profitTrendsModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const url = button.getAttribute('data-url');
                const modalContentDiv = document.getElementById('profitTrendsModalContent');
                modalContentDiv.innerHTML = `<div class="loading-spinner-container"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>Loading profit trends...</p></div>`;
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
                .then(html => { modalContentDiv.innerHTML = html; const scripts = modalContentDiv.querySelectorAll('script'); scripts.forEach(oldScript => { const newScript = document.createElement('script'); Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value)); newScript.textContent = oldScript.textContent; if (oldScript.parentNode) { oldScript.parentNode.replaceChild(newScript, oldScript); } else { modalContentDiv.appendChild(newScript); } }); })
                .catch(error => { console.error('Error loading profit trends modal content:', error); modalContentDiv.innerHTML = `<p class="text-danger text-center">Failed to load content. Please try again.</p>`; });
            });
            profitTrendsModal.addEventListener('hidden.bs.modal', function () {
                const modalContentDiv = document.getElementById('profitTrendsModalContent');
                modalContentDiv.innerHTML = `<div class="loading-spinner-container"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>Loading profit trends...</p></div>`;
            });
        }


        const itemsToSellModal = document.getElementById('itemsToSellModal');
        if (itemsToSellModal) {
            itemsToSellModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const url = button.getAttribute('data-url');
                const modalContentDiv = document.getElementById('itemsToSellModalContent');
                modalContentDiv.innerHTML = `<div class="loading-spinner-container"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>Loading items...</p></div>`;
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
                .then(html => { modalContentDiv.innerHTML = html; const scripts = modalContentDiv.querySelectorAll('script'); scripts.forEach(oldScript => { const newScript = document.createElement('script'); Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value)); newScript.textContent = oldScript.textContent; if (oldScript.parentNode) { oldScript.parentNode.replaceChild(newScript, oldScript); } else { modalContentDiv.appendChild(newScript); } }); })
                .catch(error => { console.error('Error loading items to sell modal content:', error); modalContentDiv.innerHTML = `<p class="text-danger text-center">Failed to load content. Please try again.</p>`; });
            });
            itemsToSellModal.addEventListener('hidden.bs.modal', function () {
                const modalContentDiv = document.getElementById('itemsToSellModalContent');
                modalContentDiv.innerHTML = `<div class="loading-spinner-container"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p>Loading items...</p></div>`;
            });
        }


        const totalInventoryValueModal = document.getElementById('totalInventoryValueModal');
        const totalInventoryValueModalContent = document.getElementById('totalInventoryValueModalContent');
        if (totalInventoryValueModal) {
            totalInventoryValueModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const url = button.getAttribute('data-url');
                totalInventoryValueModalContent.innerHTML = `<div class="loading-spinner-container text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading inventory value insights...</p></div>`;
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
                .then(html => { totalInventoryValueModalContent.innerHTML = html; const scripts = totalInventoryValueModalContent.querySelectorAll('script'); scripts.forEach(oldScript => { const newScript = document.createElement('script'); Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value)); newScript.textContent = oldScript.textContent; if (oldScript.parentNode) { oldScript.parentNode.replaceChild(newScript, oldScript); } else { totalInventoryValueModalContent.appendChild(newScript); } }); })
                .catch(error => { console.error('Error loading total inventory value modal content:', error); totalInventoryValueModalContent.innerHTML = `<p class="text-danger text-center py-5">Failed to load content. Please try again.</p>`; });
            });
            totalInventoryValueModal.addEventListener('hidden.bs.modal', function () {
                totalInventoryValueModalContent.innerHTML = `<div class="loading-spinner-container text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading inventory value insights...</p></div>`;
            });
        }


        // ADDED: Items Selling Well Modal Handling (UNCHANGED)
        const itemsSellingWellModal = document.getElementById('itemsSellingWellModal');
        const itemsSellingWellModalContent = document.getElementById('itemsSellingWellModalContent');
        if (itemsSellingWellModal) {
            itemsSellingWellModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const url = button.getAttribute('data-url');
                itemsSellingWellModalContent.innerHTML = `
                    <div class="loading-spinner-container text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading top selling items...</p>
                    </div>
                `;
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(html => {
                    itemsSellingWellModalContent.innerHTML = html;
                    const scripts = itemsSellingWellModalContent.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.textContent = oldScript.textContent;
                        if (oldScript.parentNode) {
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        } else {
                            itemsSellingWellModalContent.appendChild(newScript);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading items selling well modal content:', error);
                    itemsSellingWellModalContent.innerHTML = `<p class="text-danger text-center py-5">Failed to load content. Please try again.</p>`;
                });
            });
        }

        // --- NEW/UPDATED: MODAL LOGIC for Historical Trends Modal (now for column selection) ---
        const historicalTrendsModal = document.getElementById('historicalTrendsModal');
        const historicalTrendsModalBody = historicalTrendsModal.querySelector('#historicalTrendsModalBody');
        const openHistoricalTrendsModalBtn = document.getElementById('openHistoricalTrendsModalBtn');

        // This button now triggers loading the modal content for column selection
        if (openHistoricalTrendsModalBtn) {
            openHistoricalTrendsModalBtn.addEventListener('click', function() {
                // Get the currently displayed metrics to pre-check checkboxes in the modal
                const metricsParam = currentDashboardMetrics.join(',');

                historicalTrendsModalBody.innerHTML = `<div class="loading-spinner-container text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading customization options...</p></div>`; // Show spinner

                // Load the modal content for column selection, passing current metrics
                fetch(`/inventory/historical_trends_modal_content/?current_metrics=${metricsParam}`)
                    .then(response => response.text())
                    .then(html => {
                        historicalTrendsModalBody.innerHTML = html;
                        // Execute scripts embedded in the loaded HTML for the modal's functionality
                        const scripts = historicalTrendsModalBody.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                            newScript.textContent = oldScript.textContent;
                            // Ensure the script runs after it's added to the DOM
                            if (oldScript.parentNode) {
                                oldScript.parentNode.replaceChild(newScript, oldScript);
                            } else {
                                historicalTrendsModalBody.appendChild(newScript);
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error loading historical trends modal content:', error);
                        historicalTrendsModalBody.innerHTML = `<p class="text-danger text-center py-5">Failed to load customization options.</p>`;
                    });
            });
        }

        // Function to fetch and render historical sales trends for the MODAL (Full Data View)
        // This function is no longer called directly from the main page.
        // It might still be called by JS loaded within the modal if the modal offers a *separate* "full data" view.
        // For *dashboard column selection*, this function is NOT directly relevant now.
        // It's kept here because you said "dont change anything else" but logically it might be dead code if modal only does column selection.
        function fetchModalHistoricalSales(metrics) {
            const modalTableBody = document.getElementById('modalTableBody');
            const modalTableHeaders = document.getElementById('modalTableHeaders');
            const modalLoadingSpinner = document.getElementById('modalLoadingSpinner');
            const modalTableContainer = document.getElementById('modalTableContainer');

            if (!modalTableBody || !modalTableHeaders || !modalLoadingSpinner || !modalTableContainer) {
                return;
            }

            modalLoadingSpinner.style.display = 'flex';
            modalTableContainer.style.display = 'none';

            fetch(`/inventory/${companyId}/api/all_monthly_sales_trends/?metrics=${metrics}`)
              .then(response => response.json())
              .then(data => {
                let headersHtml = '<th>Month/Year</th>';
                const friendlyHeaders = { revenue: 'Revenue', net_profit: 'Net Profit', quantity_sold: 'Quantity Sold', cogs: 'COGS' };
                data.metrics_order.forEach(metric => {
                  headersHtml += `<th>${friendlyHeaders[metric] || metric}</th>`;
                });
                modalTableHeaders.innerHTML = headersHtml;

                let tableBodyHtml = '';
                data.data.forEach(rowData => {
                    let row = `<tr><td>${rowData.period}</td>`;
                    data.metrics_order.forEach(metric => {
                        let value = rowData[metric] || 0;
                        if (metric === 'revenue' || metric === 'net_profit' || metric === 'cogs') {
                            row += `<td>$${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
                        } else if (metric === 'quantity_sold') {
                            row += `<td>${value.toLocaleString('en-US')}</td>`;
                        } else {
                            row += `<td>${value}</td>`;
                        }
                    });
                    row += `</tr>`;
                    tableBodyHtml += row;
                });
                modalTableBody.innerHTML = tableBodyHtml;

                modalLoadingSpinner.style.display = 'none';
                modalTableContainer.style.display = 'block';
              })
              .catch(error => {
                console.error("Error fetching modal historical sales data:", error);
                modalLoadingSpinner.innerHTML = `<p class="text-danger text-center py-5">Failed to load data.</p>`;
              });
        }

        // --- UPDATED: Function to fetch and render historical sales for the DASHBOARD ---
        // This function is now global so it can be called from the modal's JavaScript.
        // It takes `metricsToDisplay` to control which columns are shown.
        window.updateDashboardTrends = function(metricsToDisplay = currentDashboardMetrics.join(',')) {
            const dashboardTableBody = document.getElementById('dashboardTableBody');
            const dashboardTableHeaders = document.getElementById('dashboardTableHeaders');
            const historicalSummaryLoading = document.getElementById('historicalSummaryLoading');
            const historicalSummaryTableContainer = document.getElementById('historicalSummaryTableContainer');

            if (!dashboardTableBody || !dashboardTableHeaders || !historicalSummaryLoading || !historicalSummaryTableContainer) {
                console.error("Dashboard historical trends elements not found.");
                return;
            }

            historicalSummaryLoading.style.display = 'flex';
            historicalSummaryTableContainer.style.display = 'none';

            // Update the global variable with the new metrics
            currentDashboardMetrics = metricsToDisplay.split(',').map(m => m.trim());

            // Construct the URL with the metrics parameter
            const apiUrl = `/inventory/${companyId}/api/sales_trends/?metrics=${metricsToDisplay}`;

            fetch(apiUrl)
              .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
              })
              .then(data => {
                const trendData = data.data || [];
                const metricsOrder = data.metrics_order || [];

                if (trendData.length === 0) {
                    historicalSummaryLoading.innerHTML = `<p class="text-muted text-center py-5">No historical data available.</p>`;
                    return;
                }

                let headersHtml = '<th>Month/Year</th>';
                const friendlyHeaders = { revenue: 'Revenue', net_profit: 'Net Profit', quantity_sold: 'Quantity Sold', cogs: 'COGS' };
                metricsOrder.forEach(metric => {
                  headersHtml += `<th>${friendlyHeaders[metric] || metric}</th>`;
                });
                dashboardTableHeaders.innerHTML = headersHtml;

                let tableBodyHtml = '';
                trendData.forEach(rowData => {
                    let row = `<tr><td>${rowData.period}</td>`;
                    metricsOrder.forEach(metric => {
                        let value = rowData[metric] || 0;
                        if (metric === 'revenue' || metric === 'net_profit' || metric === 'cogs') {
                            row += `<td>$${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
                        } else if (metric === 'quantity_sold') {
                            row += `<td>${value.toLocaleString('en-US')}</td>`;
                        } else {
                            row += `<td>${value}</td>`;
                        }
                    });
                    row += `</tr>`;
                    tableBodyHtml += row;
                });
                dashboardTableBody.innerHTML = tableBodyHtml;

                historicalSummaryLoading.style.display = 'none';
                historicalSummaryTableContainer.style.display = 'block';
              })
              .catch(error => {
                console.error("Error fetching dashboard historical sales data:", error);
                historicalSummaryLoading.innerHTML = `<p class="text-danger text-center py-5">Failed to load historical data.</p>`;
              });
        }

        // --- UPDATED: Initial call for dashboard historical sales ---
        updateDashboardTrends(); // Call with default metrics on page load

    });
  </script>

</body>
</html>



{% endblock%}
