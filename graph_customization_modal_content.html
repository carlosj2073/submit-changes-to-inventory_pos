{# inventory_app/templates/inventory_app/graph_customization_modal_content.html #}
{# This template contains the controls for customizing the main dashboard graph #}

<style>
    /* Styling for the customization modal content */
    .modal-body-content {
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        color: #334155;
    }
    .form-label {
        font-weight: 600;
        color: #475569;
        margin-bottom: 0.5rem;
    }
    .form-select {
        border-radius: 0.5rem;
        border: 1px solid #cbd5e1;
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        color: #334155;
    }
    .form-select:focus {
        border-color: #2196f3;
        box-shadow: 0 0 0 0.25rem rgba(33, 150, 243, 0.25);
    }
    .btn-apply-changes {
        background-color: #2196f3; /* Blue, consistent with inventory modal */
        border-color: #2196f3;
        color: white;
        font-weight: 600;
        padding: 0.6rem 1.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease;
    }
    .btn-apply-changes:hover {
        background-color: #1a7ad9;
        border-color: #1a7ad9;
    }
    .preview-chart-container {
        height: 200px; /* Smaller height for the preview chart */
        margin-top: 1.5rem;
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
    }
    .chart-placeholder {
        text-align: center;
        color: #64748b;
        padding: 2rem;
    }
</style>

<div class="modal-body-content p-4">
    <div class="mb-3">
        <label for="graphMetricSelect" class="form-label">Select Metric:</label>
        <select class="form-select" id="graphMetricSelect">
            <option value="sales">Sales</option>
            <option value="profit">Profit</option>
            <option value="gross_profit_margin">Gross Profit Margin</option>
            <option value="num_orders">Number of Orders</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="graphTimePeriodSelect" class="form-label">Select Time Period:</label>
        <select class="form-select" id="graphTimePeriodSelect">
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
        </select>
    </div>

    <div class="preview-chart-container">
        <canvas id="previewChart"></canvas>
    </div>

    <div class="d-flex justify-content-end mt-4">
        <button type="button" class="btn btn-apply-changes" id="applyGraphCustomization">Apply Changes</button>
    </div>
</div>

<script>
    // Wrap the entire script in an IIFE to create a new scope each time it's executed
    (function() {
        const previewCtx = document.getElementById('previewChart');
        let previewChartInstance; // For the preview graph in the modal

        const metricSelect = document.getElementById('graphMetricSelect');
        const timePeriodSelect = document.getElementById('graphTimePeriodSelect');
        const applyButton = document.getElementById('applyGraphCustomization');

        // Function to update the preview chart within the modal
        async function updatePreviewChart() {
            const metric = metricSelect.value;
            const timePeriod = timePeriodSelect.value;

            let metricLabel = metric.charAt(0).toUpperCase() + metric.slice(1);
            if (metric === 'gross_profit_margin') metricLabel = 'Gross Profit Margin';
            if (metric === 'num_orders') metricLabel = 'Number of Orders';

            try {
                const response = await fetch(`/inventory/api/dashboard-graph-data/?metric=${metric}&time_period=${timePeriod}`);
                const data = await response.json();

                const chartData = {
                    labels: data.labels,
                    datasets: [{
                        label: metricLabel + (metric === 'gross_profit_margin' ? ' (%)' : ' ($)'),
                        data: data.data,
                        borderColor: '#6366f1', // A different color for preview chart
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.3,
                        fill: true,
                    }]
                };

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: `Preview: ${metricLabel} (${timePeriod})`, color: '#475569' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += (metric === 'gross_profit_margin' ? '' : '$') + context.parsed.y.toFixed(2) + (metric === 'gross_profit_margin' ? '%' : ''); }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (metric === 'gross_profit_margin' ? 'Percentage' : 'Amount'),
                                color: '#4a5568'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (metric === 'gross_profit_margin') {
                                        return value.toLocaleString() + '%';
                                    } else if (metric === 'num_orders') {
                                        return value.toLocaleString(); // Return the number without any symbol
                                    } else {
                                        // This handles 'sales', 'profit', etc.
                                        return '$' + value.toLocaleString();
                                    }
                                },
                                color: '#4a5568' /* Tick label color */
                            },
                            grid: {
                                color: '#e2e8f0' /* Lighter grid lines */
                            }
                        }

                    }
                };

                if (previewChartInstance) {
                    previewChartInstance.data = chartData;
                    previewChartInstance.options = chartOptions;
                    previewChartInstance.update();
                } else {
                    previewChartInstance = new Chart(previewCtx, {
                        type: 'line',
                        data: chartData,
                        options: chartOptions
                    });
                }
            } catch (error) {
                console.error('Error fetching preview chart data:', error);
                if (previewChartInstance) {
                    previewChartInstance.destroy();
                    previewChartInstance = null;
                }
                if (previewCtx) {
                    previewCtx.style.display = 'none';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'chart-placeholder';
                    errorDiv.textContent = 'Failed to load preview. No data or API error.';
                    previewCtx.parentNode.appendChild(errorDiv);
                }
            }
        }

        // Load initial values from localStorage for the modal's dropdowns
        const currentMetric = localStorage.getItem('dashboardGraphMetric') || 'sales';
        const currentTimePeriod = localStorage.getItem('dashboardGraphTimePeriod') || 'month';
        metricSelect.value = currentMetric;
        timePeriodSelect.value = currentTimePeriod;

        // Update preview when selections change
        metricSelect.addEventListener('change', updatePreviewChart);
        timePeriodSelect.addEventListener('change', updatePreviewChart);

        // Initial preview load when modal content is displayed.
        if (previewCtx) {
             updatePreviewChart();
        }

        // Handle "Apply Changes" button click
        applyButton.addEventListener('click', function() {
            const newMetric = metricSelect.value;
            const newTimePeriod = timePeriodSelect.value;

            // Save to localStorage
            localStorage.setItem('dashboardGraphMetric', newMetric);
            localStorage.setItem('dashboardGraphTimePeriod', newTimePeriod);

            // Trigger update on main dashboard graph
            if (window.updateMainDashboardGraph) {
                window.updateMainDashboardGraph();
            } else {
                console.warn("window.updateMainDashboardGraph is not defined. Main graph will not update.");
            }

            // Close the modal
            const customizationModalElement = document.getElementById('graphCustomizationModal');
            const customizationModal = bootstrap.Modal.getInstance(customizationModalElement);
            if (customizationModal) {
                customizationModal.hide();
            }
        });
    })(); // End of IIFE
</script>