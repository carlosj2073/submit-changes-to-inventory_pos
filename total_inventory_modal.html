
<style>
    /* General body/container styling within the modal for better readability */
    .modal-body-content {
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        color: #334155; /* Slightly softer dark gray */
    }

    /* Card styling for a softer, more modern look */
    .card {
        border: none; /* Remove default border */
        border-radius: 0.75rem; /* More rounded corners */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Softer, more pronounced shadow */
        overflow: hidden; /* Ensure content respects border-radius */
    }

    .card-header {
        background-color: #f0f4f8; /* Very light blue-gray for headers */
        border-bottom: 1px solid #cbd5e1; /* Subtle border */
        font-weight: 600;
        color: #1e293b; /* Darker text for headers */
        padding: 1rem 1.5rem; /* More padding */
    }

    .card-body {
        padding: 1.5rem; /* Consistent padding */
    }

    /* KPI Cards - Emphasizing blue */
    .kpi-card-total {
        background: linear-gradient(135deg, #e0f2f7 0%, #ffffff 100%); /* Subtle gradient */
        border: 1px solid #a7d9f7; /* Light blue border */
    }
    .kpi-card-total .card-title {
        color: #2196f3; /* Stronger blue for titles */
        font-weight: 600;
    }
    .kpi-card-total .fs-3 {
        color: #1976d2; /* Darker blue for values */
        font-weight: 700;
    }

    /* Table styling for improved readability */
    .table-responsive .table {
        margin-bottom: 0; /* Remove extra margin */
    }
    .table th {
        background-color: #e2e8f0; /* Light gray-blue for table headers */
        color: #475569; /* Darker gray for header text */
        font-weight: 600;
        border-bottom: 2px solid #cbd5e1; /* Clearer separator */
    }
    .table td {
        vertical-align: middle;
        padding: 0.75rem 1rem; /* More comfortable cell padding */
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f8fafc; /* Lighter stripe */
    }

    /* Tab navigation styling */
    .nav-tabs {
        border-bottom: 1px solid #cbd5e1; /* Soft border */
    }
    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent; /* For active indicator */
        color: #64748b; /* Muted tab text */
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        transition: color 0.3s ease, border-color 0.3s ease;
    }
    .nav-tabs .nav-link:hover {
        color: #2196f3; /* Blue on hover */
        border-color: #a7d9f7; /* Light blue underline on hover */
    }
    .nav-tabs .nav-link.active {
        color: #1976d2; /* Strong blue for active tab */
        border-color: #1976d2; /* Blue underline for active tab */
        background-color: transparent; /* No background fill */
    }

    /* Headings within breakdown sections */
    .tab-content h6 {
        font-weight: 600;
        color: #475569;
        margin-bottom: 1rem;
    }
</style>

<div class="container-fluid modal-body-content">

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card kpi-card-total">
                <div class="card-body">
                    <h5 class="card-title">Total Retail Value</h5>
                    <p class="card-text fs-3">${{ total_inventory_retail_value|floatformat:2 }}</p>
                    <p class="card-text text-muted"><small>Estimated value if all current stock is sold at retail price.</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card kpi-card-total">
                <div class="card-body">
                    <h5 class="card-title">Total Cost Value</h5>
                    <p class="card-text fs-3">${{ total_inventory_cost_value|floatformat:2 }}</p>
                    <p class="card-text text-muted"><small>Total cost of acquiring all current stock.</small></p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Inventory Value Breakdown (Retail)</h5>
                </div>
                <div class="card-body">
                    <canvas id="inventoryValuePieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Detailed Inventory Breakdown</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="breakdownTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="category-tab" data-bs-toggle="tab" data-bs-target="#category-breakdown" type="button" role="tab" aria-controls="category-breakdown" aria-selected="true">By Category</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="supplier-tab" data-bs-toggle="tab" data-bs-target="#supplier-breakdown" type="button" role="tab" aria-controls="supplier-breakdown" aria-selected="false">By Supplier</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="myTabContent">
                        <div class="tab-pane fade show active" id="category-breakdown" role="tabpanel" aria-labelledby="category-tab">
                            <h6>Inventory Value by Category</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Retail Value</th>
                                            <th>Cost Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in combined_category_breakdown %}
                                        <tr>
                                            <td>{{ item.category__name|default:"N/A" }}</td>
                                            <td>${{ item.retail_value|floatformat:2 }}</td>
                                            <td>${{ item.cost_value|floatformat:2 }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="3">No category data available.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="supplier-breakdown" role="tabpanel" aria-labelledby="supplier-tab">
                            <h6>Inventory Value by Supplier</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Supplier</th>
                                            <th>Retail Value</th>
                                            <th>Cost Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in combined_supplier_breakdown %}
                                        <tr>
                                            <td>{{ item.supplier__name|default:"N/A" }}</td>
                                            <td>${{ item.retail_value|floatformat:2 }}</td>
                                            <td>${{ item.cost_value|floatformat:2 }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="3">No supplier data available.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% if combined_category_breakdown %}
    <script id="category-data" type="application/json">
        {{ combined_category_breakdown|json_script:"category-data" }}
    </script>
{% endif %}

{% if combined_supplier_breakdown %}
    <script id="supplier-data" type="application/json">
        {{ combined_supplier_breakdown|json_script:"supplier-data" }}
    </script>
{% endif %}

<script>
    const ctx = document.getElementById('inventoryValuePieChart');

    if (!ctx) {
        console.error("Canvas element 'inventoryValuePieChart' not found.");
        return; // Stop execution if the canvas is not found
    }
    
    // Parse the data from the script tags. Use a safe fallback to an empty array.
    const combinedCategoryBreakdown = JSON.parse(document.getElementById('category-data')?.textContent || '[]');
    const combinedSupplierBreakdown = JSON.parse(document.getElementById('supplier-data')?.textContent || '[]');
    
    const totalRetailValue = parseFloat('{{ total_inventory_retail_value|default:"0.0" }}');

    // ... rest of your script (the `backgroundColors` and `borderColors` arrays) ...

    let inventoryPieChart;

    function updatePieChart(data, type) {
        // ... The logic inside this function remains the same ...
        const labels = data.map(item => type === 'category' ? (item.category__name || 'Unknown Category') : (item.supplier__name || 'Unknown Supplier'));
        const values = data.map(item => parseFloat(item.retail_value));

        const percentages = values.map(value => {
            return totalRetailValue > 0 ? (value / totalRetailValue * 100).toFixed(2) : 0;
        });

        const chartData = {
            labels: labels,
            datasets: [{
                label: 'Retail Value ($)',
                data: values,
                backgroundColor: backgroundColors.slice(0, labels.length),
                borderColor: borderColors.slice(0, labels.length),
                borderWidth: 1
            }]
        };

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        color: '#475569',
                    }
                },
                title: {
                    display: true,
                    text: `Inventory Retail Value by ${type === 'category' ? 'Category' : 'Supplier'} (%)`,
                    color: '#1e293b',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            const value = context.parsed;
                            const percentage = percentages[context.dataIndex];
                            return `${label}$${value.toFixed(2)} (${percentage}%)`;
                        }
                    },
                    backgroundColor: 'rgba(45, 55, 72, 0.9)',
                    titleColor: '#f0f4f8',
                    bodyColor: '#e2e8f0',
                    borderColor: '#2196f3',
                    borderWidth: 1,
                }
            },
        };

        if (inventoryPieChart) {
            inventoryPieChart.data = chartData;
            inventoryPieChart.options = chartOptions;
            inventoryPieChart.update();
        } else {
            inventoryPieChart = new Chart(ctx, {
                type: 'pie',
                data: chartData,
                options: chartOptions
            });
        }
    }
    
    // Wrap the initial function call in a timeout to ensure the modal is fully visible
    // and the canvas has a computed size before the chart is rendered.
    setTimeout(function() {
        if (combinedCategoryBreakdown.length > 0) {
             updatePieChart(combinedCategoryBreakdown, 'category');
        } else {
            // Handle the case where no data is available
            ctx.parentNode.innerHTML = '<p class="text-center text-muted">No inventory data available for chart.</p>';
        }
    }, 100); // 100ms delay should be sufficient

    const categoryTab = document.getElementById('category-tab');
    const supplierTab = document.getElementById('supplier-tab');

    if (categoryTab) {
        categoryTab.addEventListener('shown.bs.tab', function (event) {
            updatePieChart(combinedCategoryBreakdown, 'category');
        });
    }
    if (supplierTab) {
        supplierTab.addEventListener('shown.bs.tab', function (event) {
            updatePieChart(combinedSupplierBreakdown, 'supplier');
        });
    }

</script>